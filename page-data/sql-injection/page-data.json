{"componentChunkName":"component---src-templates-post-jsx","path":"/sql-injection/","result":{"data":{"site":{"siteMetadata":{"title":"ckdhkdwns"}},"markdownRemark":{"id":"f92a641b-9c82-53f8-aff3-0368380eb767","excerpt":"실습환경 칼리 리눅스에서 아파치 웹 서버를 열어 실습을 진행하였다.  Kali-Linux: 5.4.0 Apache: 2.4.41 코드 분석 login.php\n페이지에 들어가면 간단한 로그인 폼이 있다.\nlogin-form 로그인을 처리하는 코드이다. POST 형식으로 id와 pw를 받고 query 구문을 통해 DB에서 id와 pw가 일치하는 정보를 찾는다…","html":"<h2>실습환경</h2>\n<p>칼리 리눅스에서 아파치 웹 서버를 열어 실습을 진행하였다.</p>\n<blockquote>\n<p> Kali-Linux: 5.4.0<br>\nApache: 2.4.41</p>\n</blockquote>\n<h2>코드 분석</h2>\n<p>login.php\n페이지에 들어가면 간단한 로그인 폼이 있다.\n<img src=\"/static/login-form-ff9e8f7e1d89aeea430b96de6e9343be.jpg\" alt=\"login-form\"></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">    <span class=\"token operator\">...</span>\n   \t$id<span class=\"token operator\">=</span>$_POST<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        $pw<span class=\"token operator\">=</span>$_POST<span class=\"token punctuation\">[</span><span class=\"token string\">'pw'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n \n        $query <span class=\"token operator\">=</span> <span class=\"token string\">\"select * from member where id='$id' and pw='$pw'\"</span><span class=\"token punctuation\">;</span>\n        $result <span class=\"token operator\">=</span> $connect<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>$query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n \n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysqli_num_rows</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                 $_SESSION<span class=\"token punctuation\">[</span><span class=\"token string\">'userid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>$id<span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isset</span><span class=\"token punctuation\">(</span>$_SESSION<span class=\"token punctuation\">[</span><span class=\"token string\">'userid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token operator\">?</span><span class=\"token operator\">></span>      <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n                                <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"로그인 되었습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                location<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./index.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span>\n                <span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>php\n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n                        echo <span class=\"token string\">\"session fail\"</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span> \n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n                <span class=\"token operator\">?</span><span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n                       <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"아이디 혹은 비밀번호가 잘못되었습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                       history<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>php\n    <span class=\"token operator\">...</span></code></pre></div>\n<p>로그인을 처리하는 코드이다. POST 형식으로 id와 pw를 받고 query 구문을 통해 DB에서 id와 pw가 일치하는 정보를 찾는다. </p>\n<p>취약점이 있는 부분은 바로 아래 코드 부분이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">\t<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"select * from member where id='<span class=\"token interpolation\"><span class=\"token variable\">$id</span></span>' and pw='<span class=\"token interpolation\"><span class=\"token variable\">$pw</span></span>'\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$result</span> <span class=\"token operator\">=</span> <span class=\"token variable\">$connect</span><span class=\"token operator\">-></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$query</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n \n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysqli_num_rows</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$result</span><span class=\"token punctuation\">)</span><span class=\"token operator\">==</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span></code></pre></div>\n<p>요청에서 받아온 id와 pw값을 검증 없이 그대로 사용하고 있다.\npw값에 <code class=\"language-text\">' or id='admin'#</code>를 대입하면 로그인 폼이 우회된다.\n<img src=\"/static/login-success-fbf0ee8e1af6a74651fe98155ce0e607.jpg\" alt=\"login-success\"></p>\n<h2>원리</h2>\n<p>쿼리 부분을 다시 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">\t<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"select * from member where id='<span class=\"token interpolation\"><span class=\"token variable\">$id</span></span>' and pw='<span class=\"token interpolation\"><span class=\"token variable\">$pw</span></span>'\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>여기서 pw값에 <code class=\"language-text\">' or id='admin'#</code>가 들어간다면</p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">\t<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"select * from member where id='<span class=\"token interpolation\"><span class=\"token variable\">$id</span></span>' and pw='' or id='admin'#'\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같은 형태가 된다.<br>\nSQL상에서 AND연산자는 OR연산자보다 우선순위가 높다.\n<a href=\"https://www.mysqltutorial.org/mysql-or/\">MYSQL 연산자 우선순위</a></p>\n<div class=\"gatsby-highlight\" data-language=\"php\"><pre class=\"language-php\"><code class=\"language-php\">\t<span class=\"token variable\">$query</span> <span class=\"token operator\">=</span> <span class=\"token string double-quoted-string\">\"select * from member where (id='<span class=\"token interpolation\"><span class=\"token variable\">$id</span></span>' and pw='') or id='admin'#'\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>결국 쿼리문은 DB에서 id가 admin인 row를 찾고 인증을 우회하게 되는 것이다. </p>\n<p>제일 상단의 코드를 보면 사용자가 입력한 id값에 따라 세션이 생성된다. 즉, 공격자가 유저들의 id를 알기만 하면 그 유저의 권한을 가질수 있게 되는 것이다.</p>\n<h2>취약점 보완</h2>\n<ol>\n<li><code class=\"language-text\">SELECT</code>, <code class=\"language-text\">UNION</code>과 같은 SQL 함수와 특수문자를 필터링</li>\n<li>id와 pw를 한 번에 검색하는 방식 -> id만 검색하고 pw는 id 검색 후 나온 row의 pw와 대조</li>\n<li>if문 안의 동치연산자 <code class=\"language-text\">==</code>를 <code class=\"language-text\">===</code>로 변경 </li>\n</ol>\n<h2>결과</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">\t$id<span class=\"token operator\">=</span><span class=\"token function\">preg_replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/[\\'\\;\\\"\\=\\-\\-\\#\\/*]+/\"</span><span class=\"token punctuation\">,</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span> $_POST<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        $pw<span class=\"token operator\">=</span>$_POST<span class=\"token punctuation\">[</span><span class=\"token string\">'pw'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">preg_match</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/(union|select|from|where)/i'</span><span class=\"token punctuation\">,</span> $id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        $query <span class=\"token operator\">=</span> <span class=\"token string\">\"select * from member where id='$id'\"</span><span class=\"token punctuation\">;</span>\n        $result <span class=\"token operator\">=</span> $connect<span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>$query<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \n \n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">mysqli_num_rows</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                $row<span class=\"token operator\">=</span><span class=\"token function\">mysqli_fetch_assoc</span><span class=\"token punctuation\">(</span>$result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>$row<span class=\"token punctuation\">[</span><span class=\"token string\">'pw'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">===</span> $pw<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        $_SESSION<span class=\"token punctuation\">[</span><span class=\"token string\">'userid'</span><span class=\"token punctuation\">]</span><span class=\"token operator\">=</span>$id<span class=\"token punctuation\">;</span>\n                        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">isset</span><span class=\"token punctuation\">(</span>$_SESSION<span class=\"token punctuation\">[</span><span class=\"token string\">'userid'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token operator\">?</span><span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n                                <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"로그인 되었습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                                location<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"./index.php\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>php\n                        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                                echo <span class=\"token string\">\"session fail\"</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token punctuation\">}</span> \n                <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token operator\">?</span><span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n                               <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"아이디 혹은 비밀번호가 잘못되었습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                               history<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>php\n                <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token operator\">?</span><span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>script<span class=\"token operator\">></span>\n                       <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"아이디 혹은 비밀번호가 잘못되었습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                       history<span class=\"token punctuation\">.</span><span class=\"token function\">back</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>script<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">?</span>php\n        <span class=\"token punctuation\">}</span></code></pre></div>","frontmatter":{"title":"SQL Intection 실습","date":"July 22, 2021","update":null,"tags":["sql-injection","hacking"],"series":null},"fields":{"slug":"/sql-injection/","readingTime":{"minutes":3.16}}},"seriesList":{"edges":[{"node":{"id":"f92a641b-9c82-53f8-aff3-0368380eb767","fields":{"slug":"/sql-injection/"},"frontmatter":{"title":"SQL Intection 실습"}}},{"node":{"id":"8610e26e-8d74-5948-91e2-e7adf963894d","fields":{"slug":"/2110번-공유기-설치/"},"frontmatter":{"title":"2110번 공유기 설치 Python"}}},{"node":{"id":"71201ba4-b6fc-59aa-90a3-dc595ea377dc","fields":{"slug":"/1389번-케빈-베이컨의-6단계-법칙/"},"frontmatter":{"title":"1389번 케빈 베이컨의 6단계 법칙 Python"}}},{"node":{"id":"7b1ba2b6-6a0a-540b-b77f-1b3910429f0f","fields":{"slug":"/1309번-동물원/"},"frontmatter":{"title":"1309번 동물원 Python"}}},{"node":{"id":"855d6dba-29cc-59ba-a9bd-a57d1257864a","fields":{"slug":"/1038번-감소하는-수/"},"frontmatter":{"title":"1038번 감소하는 수 Python"}}},{"node":{"id":"d9d91622-4795-5fcc-a924-8c29702d5aa4","fields":{"slug":"/1541번-잃어버린-괄호/"},"frontmatter":{"title":"1541번 잃어버린 괄호 Python"}}},{"node":{"id":"c3febc43-18c3-556a-a4d5-bb9002ef4a43","fields":{"slug":"/14502번-연구소/"},"frontmatter":{"title":"14502번 연구소 Python"}}},{"node":{"id":"c1b2ace6-822c-56b7-a4ab-fde0be99da25","fields":{"slug":"/install-java/"},"frontmatter":{"title":"Ubuntu에서 Java 설치"}}},{"node":{"id":"7afc75f6-822e-5c82-9b21-75cd172bfcb6","fields":{"slug":"/10026번-적록색약/"},"frontmatter":{"title":"10026번 적록색약 Python"}}},{"node":{"id":"1e01b2d9-da55-53be-acde-d9b12fc975a9","fields":{"slug":"/quick-start/"},"frontmatter":{"title":"Flask - Quick start"}}},{"node":{"id":"2b93cfa9-e2d6-5cff-892a-ae9ba42d5b79","fields":{"slug":"/crack-korean/"},"frontmatter":{"title":"Flask Response 한글 깨짐 현상"}}},{"node":{"id":"cd4df0d7-8640-529f-8cdb-5ea602e66369","fields":{"slug":"/gh-pages-deploy/"},"frontmatter":{"title":"gh-pages로 React 배포하기"}}},{"node":{"id":"011a1cae-6b08-5602-b5c2-651d84699833","fields":{"slug":"/init-in-goormide/"},"frontmatter":{"title":"VScode에 Spring 개발환경 구축하기"}}},{"node":{"id":"a1fb6c90-d385-5383-b921-63831b3dd0fd","fields":{"slug":"/websocket/"},"frontmatter":{"title":"Springboot Stomp로 채팅 구현하기"}}},{"node":{"id":"300ad57c-a011-5c1a-994c-3557c8004f46","fields":{"slug":"/jwt/"},"frontmatter":{"title":"JWT(JSON Web Token)"}}},{"node":{"id":"fdf83832-eef8-5fc4-bdee-b387145bd30a","fields":{"slug":"/ubuntu-sudo-apt-get-update/"},"frontmatter":{"title":"Ubuntu sudo apt-get update 다음 서명들은 공개키가 없기 때문에 인증할 수 없습니다"}}},{"node":{"id":"6bde8405-c68c-5334-9435-372186a24142","fields":{"slug":"/1916번-최소비용-구하기/"},"frontmatter":{"title":"1916번 최소비용 구하기 Python"}}},{"node":{"id":"e91f297d-08c4-5e27-a965-afd1d5aa1be0","fields":{"slug":"/7569번-토마토/"},"frontmatter":{"title":"7569번 토마토 Python"}}}]},"previous":null,"next":{"fields":{"slug":"/2110번-공유기-설치/"},"frontmatter":{"title":"2110번 공유기 설치 Python"}}},"pageContext":{"id":"f92a641b-9c82-53f8-aff3-0368380eb767","series":null,"previousPostId":null,"nextPostId":"8610e26e-8d74-5948-91e2-e7adf963894d"}},"staticQueryHashes":[]}